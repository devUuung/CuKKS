name: Build Wheels

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish wheels to PyPI'
        required: false
        type: boolean
        default: false
  release:
    types: [published]

jobs:
  build-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    strategy:
      matrix:
        cuda_version: ["118", "121", "124", "128"]
    outputs:
      image-tag-118: ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda118:${{ github.sha }}
      image-tag-121: ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda121:${{ github.sha }}
      image-tag-124: ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda124:${{ github.sha }}
      image-tag-128: ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda128:${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get lowercase repo name
        id: repo
        run: echo "lowercase=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push CUDA ${{ matrix.cuda_version }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/manylinux-cuda${{ matrix.cuda_version }}.Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda${{ matrix.cuda_version }}:${{ github.sha }}
            ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda${{ matrix.cuda_version }}:latest
          cache-from: type=gha,scope=cuda${{ matrix.cuda_version }}
          cache-to: type=gha,mode=max,scope=cuda${{ matrix.cuda_version }},ignore-error=true

  build-gpu:
    needs: build-docker
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - cuda_version: "118"
            cuda_path: "11.8"
            cuda_arch: "70;75;80;86;89;90"
            package_dir: "cukks-cu118"
          - cuda_version: "121"
            cuda_path: "12.1"
            cuda_arch: "70;75;80;86;89;90"
            package_dir: "cukks-cu121"
          - cuda_version: "124"
            cuda_path: "12.4"
            cuda_arch: "70;75;80;86;89;90"
            package_dir: "cukks-cu124"
          - cuda_version: "128"
            cuda_path: "12.8"
            cuda_arch: "70;75;80;86;89;90;120"
            package_dir: "cukks-cu128"
    steps:
      - uses: actions/checkout@v4
      
      - name: Get lowercase repo name
        id: repo
        run: echo "lowercase=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT
      
      - name: Build GPU wheels (CUDA ${{ matrix.cuda_version }})
        uses: pypa/cibuildwheel@v2.21.3
        with:
          package-dir: ${{ matrix.package_dir }}
        env:
          CIBW_BUILD: cp311-manylinux_x86_64
          CIBW_MANYLINUX_X86_64_IMAGE: ghcr.io/${{ steps.repo.outputs.lowercase }}/manylinux-cuda${{ matrix.cuda_version }}:${{ github.sha }}
          CIBW_BEFORE_ALL_LINUX: |
            set -ex
            cd /project/openfhe-gpu-public
            mkdir -p build && cd build
            cmake .. \
                -DWITH_CUDA=ON \
                -DWITH_OPENMP=ON \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr/local \
                -DBUILD_SHARED=ON \
                -DBUILD_EXAMPLES=OFF \
                -DBUILD_UNITTESTS=OFF \
                -DCMAKE_CUDA_ARCHITECTURES="${{ matrix.cuda_arch }}" \
                -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                -DOPENFHE_SKIP_EXPORT=ON
            make -j$(nproc) OPENFHEcore OPENFHEpke OPENFHEbinfhe
            mkdir -p /usr/local/lib /usr/local/include/openfhe
            cp -a lib/*.so* /usr/local/lib/
            cp -a ../src/core/include/* /usr/local/include/
            cp -a ../src/pke/include/* /usr/local/include/
            cp -a ../src/binfhe/include/* /usr/local/include/
            cp -a src/core/config_core.h /usr/local/include/openfhe/
            ldconfig
          CIBW_ENVIRONMENT_LINUX: >
            OPENFHE_GPU_ROOT=/project/openfhe-gpu-public
            OPENFHE_GPU_BUILD_DIR=/project/openfhe-gpu-public/build
            CUDA_HOME=/usr/local/cuda-${{ matrix.cuda_path }}
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: auditwheel repair -w {dest_dir} {wheel} --exclude libcuda.so.1
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-gpu-cu${{ matrix.cuda_version }}
          path: wheelhouse/*.whl

  test-gpu:
    needs: build-gpu
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cuda_version: ["118", "121", "124", "128"]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: wheels-gpu-cu${{ matrix.cuda_version }}
          path: wheelhouse
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Test GPU wheel structure (CUDA ${{ matrix.cuda_version }})
        run: |
          set -ex
          python -m venv test-env
          source test-env/bin/activate
          pip install wheelhouse/*.whl
          
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          echo "Checking installed package at: $SITE_PACKAGES/ckks"
          
          test -f "$SITE_PACKAGES/ckks/__init__.py"
          test -f "$SITE_PACKAGES/ckks/torch_api.py"
          test -f "$SITE_PACKAGES/ckks/backends/__init__.py"
          test -f "$SITE_PACKAGES/ckks/backends/ckks_openfhe_backend.cpython-311-x86_64-linux-gnu.so"
          test -f "$SITE_PACKAGES/ckks/backends/ckks_openfhe_gpu_backend.cpython-311-x86_64-linux-gnu.so"
          
          echo "All required files present for CUDA ${{ matrix.cuda_version }}!"
          echo "Note: Import test skipped - requires CUDA drivers (libcuda.so.1)"

  publish:
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.publish == true)
    needs: test-gpu
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        cuda_version: ["118", "121", "124", "128"]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: wheels-gpu-cu${{ matrix.cuda_version }}
          path: dist
      
      - name: Publish cukks-cu${{ matrix.cuda_version }} to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
